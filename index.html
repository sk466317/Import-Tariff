<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Import Tariff Sheet Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #1f2937; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #e9d5ac; zoom: 90%; }
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            body { background-color: white !important; color: black !important; zoom: 100%; }
            .page-container { box-shadow: none !important; border: none !important; width: 100% !important; margin: 0 !important; max-width: 100% !important; }
            .no-print { display: none !important; }
            input, select, textarea { border: none !important; background: transparent !important; padding: 0 !important; resize: none; color: black !important; appearance: none; }
            .bg-header-public { background-color: #1e40af !important; color: white !important; }
            .bg-header-discount { background-color: #15803d !important; color: white !important; }
        }
        .pdf-mode .no-pdf, .pdf-mode button { display: none !important; } 
        .pdf-mode, .pdf-mode * { color: #000 !important; background-color: transparent !important; border-color: #000 !important; box-shadow: none !important; }
        .pdf-mode th, .pdf-mode td { border: 1px solid #000 !important; }
        tr { page-break-inside: avoid !important; } table { page-break-inside: auto !important; }
        .input-field { border: 1px solid #6b7280; border-radius: 4px; padding: 4px 8px; width: 100%; font-size: 0.75rem; background-color: #f3f4f6; color: #111827; font-weight: 700; transition: 0.2s; }
        .input-field:focus { outline: none; border-color: #2563eb; background-color: #ffffff; }
        .tariff-table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; } 
        .tariff-table th { border: 1px solid #fff; padding: 5px 2px; text-align: center; font-weight: 800; text-transform: uppercase; overflow: hidden; }
        .tariff-table td { border: 1px solid #9ca3af; padding: 2px; text-align: center; background-color: white; color: black; }
        .tariff-table input, .tariff-table select { width: 100%; text-align: center; background: transparent; border: none; font-size: 0.7rem; font-weight: 700; color: #111827; outline: none; }
        .tariff-table textarea { width: 100%; text-align: left; background: transparent; border: none; font-size: 0.7rem; font-weight: 700; color: #111827; resize: none; padding: 2px; line-height: 1.1; }
        .view-mode .input-field, .view-mode input, .view-mode select, .view-mode textarea { pointer-events: none; background-color: #e5e7eb !important; color: #4b5563 !important; border-color: transparent; }
        .view-mode #freeDays { background-color: #fde047 !important; color: #000 !important; border: 2px solid #eab308 !important; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #loadingOverlay { background: rgba(0,0,0,0.8); display: none; z-index: 1000; } 
        #accessOverlay { background: #111827; }
        #reportsModal { background: rgba(0,0,0,0.8); display: none; z-index: 3000; align-items: flex-start; padding-top: 50px; }
        .btn-uniform { height: 34px; padding: 0 16px; font-size: 0.75rem; font-weight: 700; border-radius: 0.25rem; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-uniform:hover { transform: translateY(-1px); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-2 md:p-4 overflow-hidden" id="mainBody">

    <!-- PASSWORD OVERLAY -->
    <div id="accessOverlay" class="overlay">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl text-center w-80 md:w-96 border border-gray-700">
            <div class="mb-6 flex justify-center"><img src="https://www.hindterminals.com/adminAssets/img/siteSetting/1754228093_footer.png" alt="Hind Terminals Logo" class="h-20 object-contain bg-white p-2 rounded"></div>
            <h2 class="text-xl font-bold text-white mb-1">Import Tariff Sheet Generator</h2>
            <p class="text-gray-400 text-xs mb-6">Hind Terminals Pvt Ltd</p>
            <input type="password" id="accessPass" class="w-full border-2 border-gray-600 rounded-lg p-3 text-center text-lg mb-4 bg-gray-700 text-white outline-none" placeholder="Enter Password">
            <button onclick="checkAccess()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">UNLOCK</button>
        </div>
    </div>

    <!-- REPORTS MODAL -->
    <div id="reportsModal" class="overlay" onclick="if(event.target===this)closeReports()">
        <div class="bg-white w-11/12 max-w-7xl rounded-lg shadow-2xl overflow-hidden max-h-[85vh] flex flex-col">
            <div class="bg-indigo-900 p-4 flex justify-between items-center text-white">
                <div class="flex gap-4 items-center">
                    <h3 class="font-bold text-lg"><i class="fas fa-chart-bar mr-2"></i> Tariff Reports</h3>
                    <div class="flex bg-indigo-800 rounded p-1 gap-1">
                        <button onclick="showReport('Discounted')" class="px-3 py-1 text-xs font-bold rounded hover:bg-indigo-600 bg-indigo-600" id="btnRepDisc">Discounted</button>
                        <button onclick="showReport('FreeDays')" class="px-3 py-1 text-xs font-bold rounded hover:bg-indigo-600" id="btnRepFree">Free Days</button>
                        <button onclick="showReport('Expired')" class="px-3 py-1 text-xs font-bold rounded hover:bg-indigo-600 text-red-200" id="btnRepExp">Expired</button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadReportExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-bold shadow"><i class="fas fa-file-excel mr-1"></i> Excel</button>
                    <button onclick="closeReports()" class="hover:text-red-400 ml-2"><i class="fas fa-times text-xl"></i></button>
                </div>
            </div>
            <div class="bg-gray-100 px-4 py-2 border-b border-gray-300 font-bold text-xs flex justify-between text-gray-700">
                <div class="w-1/5">Customer</div>
                <div class="w-1/12">Mode</div>
                <div class="w-1/2">Discount Details (Head Wise)</div>
                <div class="w-1/12 text-center">End Date</div>
                <div class="w-1/12 text-right">Status</div>
            </div>
            <div class="p-0 overflow-y-auto flex-1 bg-white" id="reportsArea"></div>
            <div class="bg-gray-100 p-2 text-right text-xs text-gray-500 border-t border-gray-300" id="reportCount">0 Records</div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="overlay">
        <div class="bg-white p-6 rounded-lg shadow-2xl text-center w-96 border border-gray-200">
            <div id="progressSection">
                <div class="animate-spin rounded-full h-10 w-10 border-b-4 border-blue-600 mx-auto mb-4"></div>
                <h2 class="text-lg font-bold text-blue-900" id="loadingText">Saving Tariff Sheet...</h2>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-1 overflow-hidden"><div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div></div>
            </div>
            <div id="successSection" class="hidden">
                <div class="mb-3 text-green-500 text-6xl animate-bounce"><i class="fas fa-check-circle"></i></div>
                <h2 class="text-xl font-extrabold text-gray-800 mb-4">Saved Successfully!</h2>
                <button onclick="closeLoading()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow">OK</button>
            </div>
        </div>
    </div>

    <!-- TOP CONTROLS -->
    <div class="sticky top-0 z-50 max-w-[1400px] mx-auto mb-4 no-print opacity-0 transition-opacity duration-500" id="topControls">
        <div class="bg-gray-500 border-l-4 border-blue-600 p-3 rounded shadow-md flex flex-col justify-between gap-3">
            <div class="flex flex-wrap gap-2 items-center justify-end w-full border-b border-gray-200 pb-2">
                <span id="modeBadge" class="hidden bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-extrabold uppercase border border-gray-400 mr-auto">READ ONLY</span>
                <button onclick="openReports()" class="btn-uniform bg-indigo-600 hover:bg-indigo-700 text-white"><i class="fas fa-chart-pie mr-2"></i> Reports</button>
                <button onclick="sendEmail()" class="btn-uniform bg-blue-500 hover:bg-blue-600 text-white"><i class="fas fa-envelope mr-2"></i> Email</button>
                <button onclick="copyToClipboard()" class="btn-uniform bg-teal-600 hover:bg-teal-700 text-white"><i class="fas fa-copy mr-2"></i> Screenshot</button>
                <button onclick="downloadPDF()" class="btn-uniform bg-red-600 hover:bg-red-700 text-white"><i class="fas fa-file-pdf mr-2"></i> PDF</button>
                <div class="relative inline-block">
                    <input type="file" id="approvalUpload" class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="handleApproval(this)">
                    <button onclick="document.getElementById('approvalUpload').click()" class="btn-uniform bg-yellow-600 hover:bg-yellow-700 text-white border border-yellow-500"><i class="fas fa-file-upload mr-2"></i> Upload Approval</button>
                </div>
                <button onclick="enableEdit()" id="btnEdit" class="hidden btn-uniform bg-orange-500 hover:bg-orange-600 text-white"><i class="fas fa-edit mr-2"></i> Edit</button>
                <button onclick="revalidateRecord()" id="btnRevalid" class="hidden btn-uniform bg-purple-600 hover:bg-purple-700 text-white"><i class="fas fa-copy mr-2"></i> Revalid</button>
                <div class="w-px h-6 bg-gray-300 mx-1"></div>
                <button id="btnSave" onclick="initiateSave()" class="btn-uniform bg-green-600 hover:bg-green-700 text-white animate-pulse"><i class="fas fa-save mr-2"></i> SAVE / UPDATE</button>
                <button onclick="window.print()" class="btn-uniform bg-blue-600 hover:bg-blue-700 text-white w-10 !px-0"><i class="fas fa-print"></i></button>
                <button type="button" onclick="resetForm()" class="btn-uniform bg-red-500 hover:bg-red-600 text-white"><i class="fas fa-plus mr-2"></i> New</button>
            </div>
            <div class="flex flex-col md:flex-row gap-2 w-full items-center">
                <div id="syncStatus" class="text-[10px] font-bold text-gray-400 mr-2 whitespace-nowrap"><i class="fas fa-circle-notch fa-spin mr-1"></i> Connecting...</div>
                
                <div class="flex gap-2 items-center flex-1 w-full">
                    <!-- Filter Input (Moved to LEFT & Width Doubled to w-96) -->
                    <div class="relative w-96"> 
                        <input type="text" id="filterInput" autocomplete="off" 
                               class="border border-gray-400 rounded px-2 py-1 text-xs w-full text-black font-bold h-8" 
                               placeholder="Type Customer Name..." 
                               onkeyup="filterDropdown(this.value); suggestFilter(this.value)">
                        <!-- Filter Suggestion Box -->
                        <div id="filterSuggestionBox" class="hidden absolute z-50 w-full bg-white border border-gray-400 shadow-xl max-h-60 overflow-y-auto mt-1 rounded-b text-left"></div>
                    </div>

                    <!-- Dropdown -->
                    <select id="cloudHistory" class="border border-gray-400 rounded px-2 py-1 text-xs flex-1 text-blue-900 font-bold bg-blue-50 h-8">
                        <option value="">-- Select Customer (A-Z) --</option>
                    </select>

                    <!-- Show Button -->
                    <button onclick="loadFromDropdown(document.getElementById('cloudHistory').value)" class="btn-uniform bg-indigo-800 hover:bg-indigo-900 text-white w-16 shadow-md border border-indigo-900">SHOW</button>

                    <!-- Sync Button -->
                    <button onclick="startSync()" class="btn-uniform bg-green-400 hover:bg-gray-700 text-white w-20 !px-0"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN FORM AREA -->
    <div id="printArea" class="page-container max-w-[1350px] mx-auto bg-white-100 shadow-2xl p-6 rounded-lg border border-gray-100 opacity-0 transition-opacity duration-500 text-black min-h-[800px] bg-white">
        <input type="hidden" id="recordIdStore" value="">
        <div class="border-b-4 border-blue-900 pb-2 mb-4 flex justify-between items-start">
            <div><h2 class="text-3xl font-extrabold text-blue-900 uppercase tracking-wide">Import Tariff Sheet</h2><p class="text-gray-600 text-sm font-bold uppercase">(Discounted THC & Free days)</p><p class="text-blue-800 text-lg font-bold uppercase tracking-wide mt-1">Hind Terminals Pvt Ltd</p></div>
            <div class="text-right">
                <div class="flex items-center justify-end mb-1"><span class="text-xs font-bold text-gray-800 mr-2 uppercase">Ref No:</span><input type="text" id="tariffNo" readonly class="text-right font-mono font-bold text-blue-900 border-none w-32 bg-transparent"></div>
                <div class="flex items-center justify-end"><span class="text-xs font-bold text-gray-800 mr-2 uppercase">Date:</span><input type="date" id="dateToday" readonly class="text-right text-xs bg-transparent border-none w-32 font-bold"></div>
            </div>
        </div>

        <div class="grid grid-cols-6 gap-3 mb-4 bg-blue-200 p-4 rounded border border-blue-900 shadow-sm">
            <div class="col-span-1"><label class="block text-[10px] font-bold text-purple-700 uppercase">Tariff Mode <span class="text-red-600">*</span></label><select id="tariffMode" onchange="toggleTariffTables()" class="input-field h-8 bg-purple-50 border-purple-300 text-purple-900"><option value="">-- Select Mode --</option><option value="Discounted">Discounted Tariff</option><option value="FreeDays">Free Days Only</option></select></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-blue-700 uppercase">Destuffing Type</label><select id="destuffType" onchange="handleDestuffChange()" class="input-field h-8 bg-blue-50 border-blue-300 text-blue-900"><option value="">-- Select --</option><option value="Both">Both (Factory & ICD)</option><option value="Factory">Factory Destuffing</option><option value="ICD">ICD Destuffing</option></select></div>
            <div class="col-span-2 relative">
                <label class="block text-[10px] font-bold text-gray-600 uppercase">Customer Name <span class="text-red-600">*</span></label>
                <input type="text" id="customerName" onkeyup="suggestCustomer(this.value)" autocomplete="off" class="input-field font-bold text-blue-900 h-8 bg-white uppercase border-l-4 border-blue-600" placeholder="ENTER NAME">
                <div id="suggestionBox" class="hidden absolute z-50 w-full bg-white border border-gray-400 shadow-xl max-h-40 overflow-y-auto mt-1 rounded-b"></div>
            </div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Customer Type <span class="text-red-600">*</span></label><select id="customerType" class="input-field h-8 bg-white uppercase"><option value="">-- Select --</option><option>Importer</option><option>CHA</option><option>Forwarder</option><option>Shipping Line</option><option>Transporter</option></select></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Vol / Month <span class="text-red-600">*</span></label><input type="text" id="volMonth" class="input-field h-8 bg-white uppercase" placeholder="TEUs"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">CHA / Forwarder</label><input type="text" id="chaName" class="input-field h-8 bg-white uppercase" value="Various"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Version</label><input type="text" id="version" value="Version 1" class="input-field h-8 bg-white text-center"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Sales Person</label><select id="salesPerson" class="input-field h-8 bg-white uppercase"><option value="">-- Select --</option><option>Rajesh Kumar</option><option>Kunal Sahi</option><option>Anurag Pandey</option><option>Damanjit Singh</option><option>Chirag Rana</option><option>Mohik Sharma</option></select></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Effective From</label><input type="date" id="dateFrom" onchange="calculateMonths()" class="input-field h-8 bg-white"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">End Date</label><input type="date" id="dateTo" onchange="calculateMonths()" class="input-field h-8 bg-white"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-green-700 uppercase">Free Days</label><input type="text" id="freeDays" oninput="updateFooter(this.value); toggleTariffTables(); calculateMonths();" placeholder="" class="input-field h-8 bg-yellow-300 text-black border-yellow-500 font-extrabold"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Valid For</label><input type="text" id="validity" readonly class="input-field bg-transparent border-none text-red-700 font-bold text-xs h-8"></div>
            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Tariff Status</label><div id="statusBox" class="input-field h-8 flex items-center justify-center font-bold text-[10px] uppercase rounded border text-center" style="background-color: #bbf7d0; color: #14532d; border-color: #15803d;">Approved & Valid</div></div>
        </div>

        <div id="prominentFreeDays" class="hidden mb-6 bg-green-50 border-2 border-green-500 p-6 rounded text-center shadow-lg"><h3 class="text-green-800 text-lg font-bold uppercase mb-2">Free Days Allocation</h3><p id="prominentFreeDaysText" class="text-4xl font-extrabold text-green-600">03 DAYS</p></div>
        
        <!-- NEW ADD TABLE BUTTON -->
        <div class="flex justify-between items-center mb-4 no-print">
            <h3 class="text-sm font-bold text-gray-500 uppercase">Tariff Tables</h3>
            <button onclick="askAddTable()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-4 py-2 rounded shadow flex items-center gap-2 transition-all">
                <i class="fas fa-plus-circle"></i> ADD NEW TABLE
            </button>
        </div>

        <!-- Container for Dynamic Tables -->
        <div id="dynamicTablesArea"></div>

        <div id="tariffsContainer">
            <div id="factorySection" class="mb-6" style="display:none;"><div class="bg-blue-900 text-white text-xs font-bold px-3 py-1.5 uppercase mb-0 rounded-t flex justify-between items-center shadow"><span><i class="fas fa-industry mr-2"></i>1. Factory Destuffing Tariff</span><span class="text-[10px] text-yellow-300 bg-blue-800 px-2 py-0.5 rounded">Details Head Wise</span></div><table class="tariff-table border-2 border-blue-900" id="tableFactory"><thead><tr><th class="bg-gray-700 text-white w-[10%]" rowspan="2">Weight Slab</th><th class="bg-header-public" colspan="7">PUBLIC TARIFF (INR)</th><th class="bg-header-discount" colspan="7">DISCOUNTED TARIFF (INR)</th><th class="bg-black text-white w-[8%]" rowspan="2">Total Billing<br><span class="text-[9px] font-normal">(Public - Disc)</span></th></tr><tr class="text-[9px]"><th class="bg-blue-800 text-white w-[5.8%]">Terminal Handing</th> <th class="bg-blue-800 text-white w-[5.8%]">Infra.</th> <th class="bg-blue-800 text-white w-[5.8%]">Weighment</th> <th class="bg-blue-800 text-white w-[5.8%]">Energy Surcharge</th> <th class="bg-blue-800 text-white w-[5.8%]">EIC AND Congesion</th> <th class="bg-blue-800 text-white w-[5.8%]">Port SSR</th> <th class="bg-blue-900 border-l border-white text-white w-[5.8%]">Total</th><th class="bg-green-700 text-white w-[5.8%]">Terminal Handing</th> <th class="bg-green-700 text-white w-[5.8%]">Infra.</th> <th class="bg-green-700 text-white w-[5.8%]">Weighment</th> <th class="bg-green-700 text-white w-[5.8%]">Energy Surcharge</th> <th class="bg-green-700 text-white w-[5.8%]">EIC AND Congesion</th> <th class="bg-green-700 text-white w-[5.8%]">Port SSR</th> <th class="bg-green-900 border-l border-white text-white w-[5.8%]">Total Disc</th></tr></thead><tbody></tbody></table></div>
            <div id="icdSection" class="mb-6" style="display:none;"><div class="bg-purple-900 text-white text-xs font-bold px-3 py-1.5 uppercase mb-0 rounded-t shadow"><i class="fas fa-warehouse mr-2"></i>2. ICD Destuffing Weight Slab</div><table class="tariff-table border-2 border-purple-900" id="tableICD"><thead><tr><th class="bg-gray-700 text-white w-[10%]" rowspan="2">Weight Slab</th><th class="bg-header-public" colspan="8">PUBLIC TARIFF (INR)</th><th class="bg-header-discount" colspan="8">DISCOUNTED TARIFF (INR)</th><th class="bg-black text-white w-[8%]" rowspan="2">Total Billing<br><span class="text-[9px] font-normal">(Public - Disc)</span></th></tr><tr class="text-[9px]"><th class="bg-purple-800 text-white w-[5.1%]">Destuff</th> <th class="bg-purple-800 text-white w-[5.1%]">THC</th> <th class="bg-purple-800 text-white w-[5.1%]">Infra</th> <th class="bg-purple-800 text-white w-[5.1%]">Weight</th> <th class="bg-purple-800 text-white w-[5.1%]">Energy</th> <th class="bg-purple-800 text-white w-[5.1%]">EIC/Cong</th> <th class="bg-purple-800 text-white w-[5.1%]">Port SSR</th> <th class="bg-purple-900 border-l border-white text-white w-[5.1%]">Total</th><th class="bg-green-700 text-white w-[5.1%]">Destuff</th> <th class="bg-green-700 text-white w-[5.1%]">THC</th> <th class="bg-green-700 text-white w-[5.1%]">Infra</th> <th class="bg-green-700 text-white w-[5.1%]">Weight</th> <th class="bg-green-700 text-white w-[5.1%]">Energy</th> <th class="bg-green-700 text-white w-[5.1%]">EIC/Cong</th> <th class="bg-green-700 text-white w-[5.1%]">Port SSR</th> <th class="bg-green-900 border-l border-white text-white w-[5.1%]">Total Disc</th></tr></thead><tbody></tbody></table><div class="mt-0 bg-green-50 border-x-2 border-b-2 border-green-600 p-2 text-center"><p class="text-xs font-extrabold text-green-900" id="freeDaysDisplay">DISCOUNTED: ARRIVAL + 03 DAYS FREE TIME ONLY</p></div></div>
        </div>

        <div class="mb-4 pt-4">
            <div class="flex justify-between items-end mb-1">
                <div class="bg-yellow-600 text-white px-3 py-1.5 rounded-t font-bold text-xs uppercase"><i class="fas fa-truck mr-2"></i> 3. Transport Tariff</div>
                <div class="mb-1 flex items-center gap-2"><label class="text-[10px] font-bold text-gray-700 uppercase">Claimed By:</label><input type="text" id="transportClaimedBy" class="border border-gray-400 rounded px-2 py-0.5 text-xs font-bold w-80 bg-white uppercase" value="TRANSPORTER"><button onclick="addTransportRow()" class="bg-white text-yellow-700 hover:bg-gray-100 text-[10px] font-bold px-2 py-0.5 rounded no-print shadow uppercase border border-yellow-600 no-pdf">Add Location</button></div>
            </div>
            <table class="tariff-table border-2 border-yellow-600" id="tableTransport"><thead><tr class="bg-yellow-700 text-white"><th class="w-32">Transporter <span class="text-red-200">*</span></th> <th class="w-32">Origin</th> <th class="w-32">Destination</th> <th class="w-32">Return Empty</th> <th class="w-20">Discount (â‚¹)</th> <th class="w-64">Remarks</th> <th class="bg-white border-none w-6 no-print"></th></tr></thead><tbody id="tbodyTransport"></tbody></table>
        </div>

        <div class="mb-4 pt-2">
            <div class="flex justify-between items-end mb-1">
                <div class="bg-teal-700 text-white px-3 py-1.5 rounded-t font-bold text-xs uppercase"><i class="fas fa-gift mr-2"></i> 4. Incentive Details</div>
                <div class="mb-1 flex items-center gap-2"><label class="text-[10px] font-bold text-gray-700 uppercase">Claimed By:</label><input type="text" id="incentiveClaimedBy" class="border border-gray-400 rounded px-2 py-0.5 text-xs font-bold w-80 bg-white uppercase" value="CHA"><button onclick="addIncentiveRow()" class="bg-white text-teal-800 hover:bg-gray-100 text-[10px] font-bold px-2 py-0.5 rounded no-print shadow uppercase border border-teal-700 no-pdf">Add Row</button></div>
            </div>
            <table class="tariff-table border-2 border-teal-700"><thead><tr class="bg-teal-800 text-white"><th class="w-48">Line (MSC / NON MSC)</th> <th>Discount 20"</th> <th>Discount 40"</th> <th class="w-64">Remarks</th> <th class="bg-white border-none w-6 no-print"></th></tr></thead><tbody id="tbodyIncentive"></tbody></table>
        </div>

        <div class="bg-yellow-50 p-2 rounded border border-yellow-400 mb-4"><label class="block text-[10px] font-bold text-yellow-900 mb-1 uppercase">Remarks / Special Notes</label><textarea id="remarks" class="w-full border border-yellow-300 rounded p-1 text-xs bg-white focus:outline-none text-gray-700 font-bold" rows="2"></textarea></div>

        <div id="approvalPreviewSection" class="hidden mt-6 border-2 border-dashed border-gray-400 rounded p-4 bg-gray-50 break-inside-avoid">
            <div class="flex justify-between items-center mb-2 border-b border-gray-300 pb-1">
                <h3 class="text-sm font-bold text-gray-700 uppercase"><i class="fas fa-paperclip mr-1"></i> Approval Reference</h3>
                <span id="approvalFileName" class="text-xs text-gray-500"></span>
            </div>
            <div id="previewContainer" class="w-full h-96 flex items-center justify-center bg-white border border-gray-200"></div>
        </div>

        <div class="mt-6 pt-4 border-t-2 border-gray-400 flex justify-between print-only">
            <div class="text-center"><p class="font-bold text-[10px] border-t-2 border-black px-8 pt-1 inline-block text-black uppercase">Prepared By</p></div>
            <div class="text-center"><p class="font-bold text-[10px] border-t-2 border-black px-8 pt-1 inline-block text-black uppercase">Approved By</p></div>
        </div>
    </div>

    <script>
        const SCRIPT_SAVE_URL = 'https://script.google.com/macros/s/AKfycbxXE8V02fHhcNWbPzUEhPREj9KbnRJiPzIjJFnNkF5HtCGOCB1cqActpBg1LgWpZTMJ/exec';
        const SHEET_ID = '11LsDU-tfxh8vJ4RK_JYcF5AYJQBzLSMZDmOvfKcPE5s';
        const DIRECT_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

        const factoryData = [{slab:"(20) 0 - 27MT",p:[3595,2300,200,337,2500,150]},{slab:"(20) 27 - 30MT",p:[4494,2300,200,337,2500,150]},{slab:"(20) > 31MT",p:[7190,2300,200,337,2500,150]},{slab:"For 40\"",p:[6790,4500,200,509,3500,300]}];
        const icdData = [{slab:"(20) 0 - 27MT",p:[900,4345,2300,200,337,2500,150]},{slab:"(20) 27 - 30MT",p:[900,5431,2300,200,337,2500,150]},{slab:"(20) > 31MT",p:[900,8690,2300,200,337,2500,150]},{slab:"For 40\"",p:[1800,8240,4500,200,509,3500,300]}];

        let globalRecords = [];
        let loadedRecordId = null;
        let currentReportData = []; 

        function checkAccess() {
            if (document.getElementById('accessPass').value === "16111980") {
                document.getElementById('accessOverlay').style.display = "none";
                document.getElementById('mainBody').classList.remove('overflow-hidden');
                document.getElementById('topControls').classList.remove('opacity-0');
                document.getElementById('printArea').classList.remove('opacity-0');
                initApp();
            } else { alert("Wrong Password"); }
        }

        function initApp() {
            document.getElementById('dateToday').valueAsDate = new Date();
            document.getElementById('tariffNo').value = `TS-${new Date().getFullYear()}${Math.floor(1000+Math.random()*9000)}`;
            renderTable('tableFactory', factoryData, 6);
            renderTable('tableICD', icdData, 7);
            addTransportRow();
            addIncentiveRow();
            startSync();
            toggleTariffTables();
        }

        // --- CORE FUNCTIONS ---
        function sendEmail() {
            const cust = document.getElementById('customerName').value;
            const mode = document.getElementById('tariffMode').value;
            if(!cust) return alert("Please create or load a tariff first.");
            const to = "aman.sharma@hindterminals.com;sourav.thakur@hindterminals.com;sukhwinder.singh@hindterminals.com";
            const cc = "rajesh.kumar@hindterminals.com;rajeev.sharma@hindterminals.com;dinesh.negi@hindterminals.com;ekta@hindterminals.com";
            const subject = `Import Tariff Sheet of "${cust}" ${mode}`;
            const body = `Dear Accounts Team,%0D%0A%0D%0APlease find attached Tariff Sheet of "${cust}"%0D%0A"${mode}"%0D%0A%0D%0AThanks and Regards,%0D%0AVikram Singh%0D%0AHind Terminals Pvt Ltd.`;
            window.location.href = `mailto:${to}?cc=${cc}&subject=${subject}&body=${body}`;
        }

        function toggleReadOnly(state) {
            const container = document.getElementById('printArea');
            const badge = document.getElementById('modeBadge');
            const btnEdit = document.getElementById('btnEdit');
            const btnRevalid = document.getElementById('btnRevalid');
            const btnSave = document.getElementById('btnSave');
            if(state) {
                container.classList.add('view-mode');
                badge.classList.remove('hidden');
                btnEdit.classList.remove('hidden');
                btnRevalid.classList.remove('hidden');
                btnSave.disabled = true;
                btnSave.classList.add('opacity-50', 'cursor-not-allowed');
                btnSave.classList.remove('animate-pulse');
            } else {
                container.classList.remove('view-mode');
                badge.classList.add('hidden');
                btnEdit.classList.add('hidden');
                btnRevalid.classList.add('hidden');
                btnSave.disabled = false;
                btnSave.classList.remove('opacity-50', 'cursor-not-allowed');
                btnSave.classList.add('animate-pulse');
            }
        }
        function enableEdit() {
            if (prompt("Enter Password to Edit:") !== "Honey@143143") return alert("Wrong Password!");
            if(confirm("Enable Editing? This will UPDATE the current record on Save.")) {
                toggleReadOnly(false);
            }
        }

        async function initiateSave() {
            calculateMonths();
            const cust = document.getElementById('customerName').value.trim();
            const mode = document.getElementById('tariffMode').value;
            if(!cust) return alert("Error: Customer Name is Required");
            if(!mode) return alert("Error: Tariff Mode is Required");
            if(!document.getElementById('dateFrom').value) return alert("Error: Dates are Required");

            let entryId = loadedRecordId || document.getElementById('recordIdStore').value;
            if (!entryId) {
                entryId = Date.now().toString(); // Create New ID
            }

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').innerText = loadedRecordId ? "Updating Record..." : "Saving Tariff Sheet...";
            document.getElementById('btnSave').disabled = true;

            const progressBar = document.getElementById('progressBar');
            let progress = 0;
            const interval = setInterval(() => { progress += 10; if(progress > 90) progress = 90; progressBar.style.width = progress + '%'; }, 200);

            try {
                const factoryValues = [];
                for(let i=0; i<factoryData.length; i++) {
                    const vals = [];
                    for(let k=0; k<6; k++) vals.push(document.getElementById(`tableFactory_${i}_d${k}`).value || "");
                    factoryValues.push(vals);
                }
                const icdValues = [];
                for(let i=0; i<icdData.length; i++) {
                    const vals = [];
                    for(let k=0; k<7; k++) vals.push(document.getElementById(`tableICD_${i}_d${k}`).value || "");
                    icdValues.push(vals);
                }
                
                // --- Save Dynamic Tables ---
                const transValues = [];
                document.querySelectorAll('#tbodyTransport tr').forEach(tr => {
                    const uid = tr.querySelector('select').id.split('_trans')[0];
                    transValues.push({
                        t: document.getElementById(`${uid}_trans`).value,
                        d: document.getElementById(`${uid}_dest`).value,
                        b: document.getElementById(`${uid}_base`).value,
                        v: document.getElementById(`${uid}_disc`).value
                    });
                });

                const dynTables = [];
                document.querySelectorAll('.dynamic-table-wrapper').forEach(wrapper => {
                    const type = wrapper.dataset.type;
                    const start = wrapper.querySelector('.dyn-start-date').value;
                    const end = wrapper.querySelector('.dyn-end-date').value;
                    const colCount = type === 'Factory' ? 6 : 7;
                    const rowCount = 4; // Rows are fixed currently
                    
                    const tableValues = [];
                    const inputs = wrapper.querySelectorAll('.dyn-input');
                    
                    for (let i = 0; i < rowCount; i++) {
                        const rowVals = [];
                        for (let k = 0; k < colCount; k++) {
                            const index = (i * colCount) + k;
                            rowVals.push(inputs[index].value);
                        }
                        tableValues.push(rowVals);
                    }

                    dynTables.push({ type, start, end, values: tableValues });
                });

                if(dynTables.length > 0) {
                    transValues.push({ _sys_type: 'DYNAMIC_DATA', payload: dynTables });
                }

                const incValues = [];
                document.querySelectorAll('#tbodyIncentive tr').forEach(tr => {
                    const uid = tr.querySelector('select').id.split('_line')[0];
                    incValues.push({
                        l: document.getElementById(`${uid}_line`).value,
                        d20: document.getElementById(`${uid}_d20`).value,
                        d40: document.getElementById(`${uid}_d40`).value,
                        rem: document.getElementById(`${uid}_rem`).value
                    });
                });

                const fd = new FormData();
                fd.append('Date', document.getElementById('dateToday').value);
                fd.append('Name', `[MASTER] ${cust} [ID:${entryId}]`);
                fd.append('Email', `Ref: ${document.getElementById('tariffNo').value} | Dates: ${document.getElementById('dateFrom').value} to ${document.getElementById('dateTo').value} | Mode: ${mode} | Type: ${document.getElementById('destuffType').value}`);
                fd.append('Phone', `Valid: ${document.getElementById('validity').value} | Free: ${document.getElementById('freeDays').value} | CType: ${document.getElementById('customerType').value} | Vol: ${document.getElementById('volMonth').value}`);
                fd.append('Department', `Sales: ${document.getElementById('salesPerson').value} | CHA: ${document.getElementById('chaName').value} | TC: ${document.getElementById('transportClaimedBy').value} | IC: ${document.getElementById('incentiveClaimedBy').value}`);
                fd.append('City', `Ver: ${document.getElementById('version').value} | Rem: ${document.getElementById('remarks').value}`);
                fd.append('Data1', JSON.stringify(factoryValues));
                fd.append('Data2', JSON.stringify(icdValues));
                fd.append('Data3', JSON.stringify(transValues));
                fd.append('Data4', JSON.stringify(incValues));

                await fetch(SCRIPT_SAVE_URL + '?t=' + Date.now(), { 
                    method: 'POST', 
                    body: fd, 
                    mode: 'no-cors',
                    cache: 'no-store',
                    keepalive: true
                });

                // --- MANUALLY UPDATE LOCAL RECORDS (OPTIMISTIC UPDATE) ---
                // This fixes the issue where reloading immediately shows old data because Google Sheet hasn't updated the CSV yet.
                const newRec = {
                    id: entryId,
                    date: document.getElementById('dateToday').value,
                    name: cust,
                    ref: document.getElementById('tariffNo').value,
                    dates: `${document.getElementById('dateFrom').value} to ${document.getElementById('dateTo').value}`,
                    mode: mode,
                    type: document.getElementById('destuffType').value,
                    valid: document.getElementById('validity').value,
                    free: document.getElementById('freeDays').value,
                    cType: document.getElementById('customerType').value,
                    vol: document.getElementById('volMonth').value,
                    sales: document.getElementById('salesPerson').value,
                    cha: document.getElementById('chaName').value,
                    tc: document.getElementById('transportClaimedBy').value,
                    ic: document.getElementById('incentiveClaimedBy').value,
                    ver: document.getElementById('version').value,
                    rem: document.getElementById('remarks').value,
                    jF: JSON.stringify(factoryValues),
                    jI: JSON.stringify(icdValues),
                    jT: JSON.stringify(transValues), 
                    jInc: JSON.stringify(incValues)
                };

                const existingIndex = globalRecords.findIndex(r => r.id === entryId);
                if (existingIndex >= 0) {
                    globalRecords[existingIndex] = newRec;
                } else {
                    globalRecords.push(newRec);
                }
                updateDropdown(); // Update the dropdown immediately
                // ---------------------------------------------------------

                clearInterval(interval);
                progressBar.style.width = '100%';
                setTimeout(() => {
                    document.getElementById('progressSection').classList.add('hidden');
                    document.getElementById('successSection').classList.remove('hidden');
                    loadedRecordId = entryId;
                    document.getElementById('recordIdStore').value = entryId;
                    toggleReadOnly(true);
                    // REMOVED startSync() here to prevent overwriting our fresh local data with stale cloud data
                }, 500);

            } catch(e) {
                alert("Error: " + e.message);
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('btnSave').disabled = false;
            }
        }

        async function startSync() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> Loading...';
            try {
                const response = await fetch(DIRECT_CSV_URL + '&t=' + Date.now());
                if (!response.ok) throw new Error("Blocked");
                const text = await response.text();
                processCloudData(parseCSV(text));
                statusEl.innerHTML = `<i class="fas fa-circle text-green-600 mr-1" style="font-size: 8px;"></i> <span class="font-extrabold text-green-900">Online</span>`;
            } catch (e) {
                syncWithVizApi();
            }
        }
        function syncWithVizApi() {
            const callbackName = 'jsonp_' + Date.now();
            window[callbackName] = function(response) {
                if (response.status === 'error') return;
                const rows = response.table.rows.map(r => r.c.map(c => c ? c.v : ""));
                document.getElementById('syncStatus').innerHTML = `<i class="fas fa-circle text-green-600 mr-1" style="font-size: 8px;"></i> <span class="font-extrabold text-green-900">Online (API)</span>`;
                processCloudData(rows);
                document.getElementById(callbackName).remove();
                delete window[callbackName];
            };
            const script = document.createElement('script');
            script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=0&tqx=responseHandler:${callbackName}`;
            script.id = callbackName;
            document.body.appendChild(script);
        }

        function parseCSV(str) { const arr = []; let q = false, c = 0, r = 0; for (let i = 0; i < str.length; i++) { let cc = str[i], nc = str[i + 1]; arr[r] = arr[r] || []; arr[r][c] = arr[r][c] || ''; if (cc == '"' && q && nc == '"') { arr[r][c] += '"'; ++i; } else if (cc == '"') { q = !q; } else if (cc == ',' && !q) { ++c; } else if (cc == '\r' && !q && nc == '\n') { ++r; c = 0; ++i; } else if (cc == '\n' && !q) { ++r; c = 0; } else { arr[r][c] += cc; } } return arr; }

        function processCloudData(rows) {
            const recordMap = new Map();
            rows.forEach(r => {
                if(r[1] && r[1].includes('[MASTER]')) {
                    const rawName = r[1].replace('[MASTER]','').trim();
                    const idMatch = rawName.match(/\[ID:(.*?)\]/);
                    const realID = idMatch ? idMatch[1] : rawName;
                    const realName = rawName.split('[ID')[0].trim();
                    const m1 = (r[2]||"").split('|'), m2 = (r[3]||"").split('|'), m3 = (r[4]||"").split('|'), m4 = (r[5]||"").split('|');
                    recordMap.set(realID, {
                        id: realID, date: r[0], name: realName,
                        ref: val(m1,'Ref:'), dates: val(m1,'Dates:'), mode: val(m1,'Mode:'), type: val(m1,'Type:'),
                        valid: val(m2,'Valid:'), free: val(m2,'Free:'), cType: val(m2,'CType:'), vol: val(m2,'Vol:'),
                        sales: val(m3,'Sales:'), cha: val(m3,'CHA:'), tc: val(m3,'TC:'), ic: val(m3,'IC:'),
                        ver: val(m4,'Ver:'), rem: val(m4,'Rem:'),
                        jF: r[6], jI: r[7], jT: r[8], jInc: r[9]
                    });
                }
            });
            globalRecords = Array.from(recordMap.values());
            updateDropdown();
        }

        function updateDropdown() {
            const dd = document.getElementById('cloudHistory');
            dd.innerHTML = '<option value="">-- Select Customer (A-Z) --</option>';
            globalRecords.sort((a,b) => a.name.localeCompare(b.name)).forEach(r => {
                let dInfo = ""; if(r.dates && r.dates.includes('to')) { const p = r.dates.split('to'); if(p[1]) dInfo = ` [Till ${p[1].trim()}]`; }
                const opt = document.createElement('option'); opt.value = r.id; opt.text = `${r.name} - ${r.ver} (${r.mode})${dInfo}`; dd.appendChild(opt);
            });
        }

        function val(arr, key) { const f = arr.find(s => s.includes(key)); return f ? f.split(key)[1].trim() : ""; }

        function loadFromDropdown(id) { const r = globalRecords.find(x => x.id == id); if(r) loadRecord(r); }
        function loadRecord(rec) {
            if(!confirm("Load " + rec.name + "?")) return;
            loadedRecordId = rec.id; 
            document.getElementById('recordIdStore').value = rec.id;
            document.getElementById('customerName').value = rec.name;
            document.getElementById('tariffNo').value = rec.ref;
            if(rec.dates && rec.dates.includes('to')) { const p = rec.dates.split('to'); document.getElementById('dateFrom').value = p[0].trim(); document.getElementById('dateTo').value = p[1].trim(); }
            
            const map = {'tariffMode':'mode','destuffType':'type','customerType':'cType','volMonth':'vol','chaName':'cha','salesPerson':'sales','freeDays':'free','validity':'valid','version':'ver','remarks':'rem'};
            for(let k in map) document.getElementById(k).value = rec[map[k]] || "";
            document.getElementById('transportClaimedBy').value = rec.tc || rec.name;
            document.getElementById('incentiveClaimedBy').value = rec.ic || rec.name;

            fillT('tableFactory', rec.jF, 4, 6);
            fillT('tableICD', rec.jI, 4, 7);
            
            // --- Load Dynamic Tables ---
            document.getElementById('dynamicTablesArea').innerHTML = ''; // Clear existing dynamic tables
            document.getElementById('tbodyTransport').innerHTML = '';
            
            const rawTransportData = JSON.parse(rec.jT||'[]');
            
            const realTransData = [];
            const dynDataList = [];

            rawTransportData.forEach(item => {
                if (item._sys_type === 'DYNAMIC_DATA') {
                    item.payload.forEach(tbl => dynDataList.push(tbl));
                } else {
                    realTransData.push(item);
                }
            });

            // Render Transport Rows
            realTransData.forEach(x => addTransportRow({trans:x.t, dest:x.d, base:x.b, disc:x.v}));
            
            // Render Dynamic Tables
            dynDataList.forEach(tbl => {
                createDynamicTable(tbl.type, tbl);
            });
            // ---------------------------
            
            document.getElementById('tbodyIncentive').innerHTML = '';
            (JSON.parse(rec.jInc||'[]')).forEach(x => addIncentiveRow({line:x.l, d20:x.d20, d40:x.d40, rem:x.rem}));

            calculateMonths(); updateFooter(rec.free); toggleTariffTables(); toggleReadOnly(true);
        }
        function fillT(tid, json, r, c) { try { const d = JSON.parse(json); d.forEach((rw, i) => { rw.forEach((v, j) => { const e = document.getElementById(`${tid}_${i}_d${j}`); if(e) e.value = v; }); calcRow(`${tid}_${i}`, c); }); } catch(e){} }

        function renderTable(tableId, data, colCount) {
            const tbody = document.getElementById(tableId).querySelector('tbody'); tbody.innerHTML = '';
            data.forEach((row, rIdx) => {
                const tr = document.createElement('tr'); const uid = `${tableId}_${rIdx}`;
                let html = `<td class="font-bold text-left px-2 bg-gray-50">${row.slab}</td>`;
                let pTotal = 0;
                row.p.forEach((val, cIdx) => { pTotal += val; html += `<td><input type="number" id="${uid}_p${cIdx}" value="${val}" readonly tabindex="-1" class="text-blue-900 font-bold bg-gray-100 pointer-events-none"></td>`; });
                html += `<td class="bg-blue-100 font-extrabold text-blue-900" id="${uid}_ptotal">${pTotal}</td>`;
                for(let i=0; i<colCount; i++) html += `<td><input type="number" id="${uid}_d${i}" oninput="calcRow('${uid}', ${colCount})" class="text-green-700 font-bold border-b border-green-100"></td>`;
                html += `<td class="bg-green-100 text-red-600 font-extrabold" id="${uid}_dtotal">0</td><td class="bg-black text-white font-bold" id="${uid}_final">${pTotal}</td>`;
                tr.innerHTML = html; tbody.appendChild(tr);
            });
        }
        function calcRow(uid, colCount) {
            let pTotal = 0, dTotal = 0;
            for(let i=0; i<colCount; i++) pTotal += parseFloat(document.getElementById(`${uid}_p${i}`).value)||0;
            for(let i=0; i<colCount; i++) dTotal += parseFloat(document.getElementById(`${uid}_d${i}`).value)||0;
            document.getElementById(`${uid}_dtotal`).innerText = dTotal;
            document.getElementById(`${uid}_final`).innerText = (pTotal - dTotal);
        }
        
        function addTransportRow(data={}) {
            const tbody = document.getElementById('tbodyTransport'); const tr = document.createElement('tr'); const uid = `trans_${Date.now()}`;
            tr.innerHTML = `<td><select id="${uid}_trans" class="text-blue-900 font-bold"><option value="">--</option><option>HCPL</option><option>PCS</option><option>OTHER</option><option>SELF</option></select></td><td><input value="Kilaraipur" readonly class="text-center font-bold"></td><td><select id="${uid}_dest" onchange="document.getElementById('${uid}_disc').value=this.value==='Ludhiana'?2000:(this.value==='Mandi Gobindgarh'?1500:0)" class="font-bold uppercase"><option value="">--</option><option>Ludhiana</option><option>Mandi Gobindgarh</option><option>Malerkotla</option><option>Sangrur</option><option>Dhuri</option><option>Sunam</option></select></td><td><input id="${uid}_ret" value="${data.ret||'Empty Yard'}" class="text-center font-bold"></td><td><input type="number" id="${uid}_disc" value="${data.disc||''}" class="bg-yellow-50 text-red-600 font-bold"></td><td><textarea id="${uid}_base" class="text-xs font-bold resize-none">${data.base||''}</textarea></td><td class="no-print"><button onclick="this.closest('tr').remove()" class="text-red-500"><i class="fas fa-times"></i></button></td>`;
            tbody.appendChild(tr);
            if(data.trans) document.getElementById(`${uid}_trans`).value = data.trans;
            if(data.dest) document.getElementById(`${uid}_dest`).value = data.dest;
        }
        function addIncentiveRow(data={}) {
            const tbody = document.getElementById('tbodyIncentive'); const tr = document.createElement('tr'); const uid = `inc_${Date.now()}`;
            tr.innerHTML = `<td><select id="${uid}_line" onchange="const v=this.value==='MSC'?300:(this.value==='NON MSC'?600:0);document.getElementById('${uid}_d20').value=v;document.getElementById('${uid}_d40').value=v" class="font-bold w-full"><option value="">--</option><option>MSC</option><option>NON MSC</option></select></td><td><input type="number" id="${uid}_d20" value="${data.d20||''}" class="bg-teal-50 font-bold"></td><td><input type="number" id="${uid}_d40" value="${data.d40||''}" class="bg-teal-50 font-bold"></td><td><textarea id="${uid}_rem" class="text-xs font-bold resize-none">${data.rem||''}</textarea></td><td class="no-print"><button onclick="this.closest('tr').remove()" class="text-red-500"><i class="fas fa-times"></i></button></td>`;
            tbody.appendChild(tr);
            if(data.line) document.getElementById(`${uid}_line`).value = data.line;
        }

        function resetForm() { 
            if (prompt("Enter Password to Create New:") !== "Honey@143143") return alert("Wrong Password");
            if(!confirm("Clear form?")) return; 
            loadedRecordId = null; 
            document.getElementById('recordIdStore').value = ""; 
            // --- Clear Dynamic Tables ---
            document.getElementById('dynamicTablesArea').innerHTML = ''; 
            // ----------------------------
            document.querySelectorAll('input:not([readonly]),textarea,select').forEach(e => e.value = ""); 
            document.getElementById('version').value = "Version 1"; 
            document.getElementById('chaName').value = "Various"; 
            toggleReadOnly(false); 
            addTransportRow(); 
            addIncentiveRow(); 
        }
        
        function revalidateRecord() { 
            if(prompt("Password:") !== "Honey@143143") return; 
            toggleReadOnly(false); 
            loadedRecordId = null;
            document.getElementById('recordIdStore').value = "";
            const v = document.getElementById('version'); 
            v.value = "Version " + ((parseInt(v.value.replace(/\D/g,''))||1)+1); 
            document.getElementById('dateToday').valueAsDate = new Date(); 
            alert("Version Updated. Clicking Save will create a NEW RECORD."); 
        }

        function calculateMonths() { const d1 = new Date(document.getElementById('dateFrom').value), d2 = new Date(document.getElementById('dateTo').value); if(d1 && d2 && d2 > d1) { let m = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth()); if(d2.getDate() < d1.getDate()) m--; const days = Math.ceil(Math.abs(d2 - d1) / 86400000); document.getElementById('validity').value = `${m} Months (${days} Days)`; const s = document.getElementById('statusBox'); if(new Date() > d2) { s.innerText = "EXPIRED"; s.style.backgroundColor = "#fecaca"; s.style.color = "#7f1d1d"; } else { s.innerText = "Active"; s.style.backgroundColor = "#bbf7d0"; s.style.color = "#14532d"; } } }
        function updateFooter(v) { const t = v ? v.toUpperCase() : "03 DAYS"; document.getElementById('freeDaysDisplay').innerText = `DISCOUNTED: ARRIVAL + ${t} FREE TIME ONLY`; document.getElementById('prominentFreeDaysText').innerText = t; }
        function handleDestuffChange() { const v = document.getElementById('destuffType').value; if(v && v !== 'Both') document.getElementById('tariffMode').value = 'Discounted'; toggleTariffTables(); }
        function toggleTariffTables() { const m = document.getElementById('tariffMode').value, t = document.getElementById('destuffType').value, fs = document.getElementById('factorySection'), is = document.getElementById('icdSection'), pb = document.getElementById('prominentFreeDays'); fs.style.display = 'none'; is.style.display = 'none'; pb.style.display = 'none'; document.getElementById('destuffType').disabled = false; if(m === 'FreeDays') { pb.style.display = 'block'; document.getElementById('destuffType').value = ""; document.getElementById('destuffType').disabled = true; } else { if(t === 'Factory' || t === 'Both') fs.style.display = 'block'; if(t === 'ICD' || t === 'Both') is.style.display = 'block'; } }
        function filterDropdown(v) { const o = document.getElementById('cloudHistory').options; v = v.toLowerCase(); for(let i=1; i<o.length; i++) o[i].style.display = o[i].text.toLowerCase().includes(v) ? 'block' : 'none'; }
        
        function downloadPDF() { document.getElementById('printArea').classList.add('pdf-mode'); const oz = document.body.style.zoom; document.body.style.zoom = "100%"; html2pdf().set({ margin: [5, 5, 5, 5], filename: `${document.getElementById('customerName').value}_Tariff.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } }).from(document.getElementById('printArea')).save().then(() => { document.body.style.zoom = oz; document.getElementById('printArea').classList.remove('pdf-mode'); }); }
        function copyToClipboard() { const el = document.getElementById('printArea'), oz = document.body.style.zoom; document.body.style.zoom = "100%"; html2canvas(el, { scale: 2, useCORS: true }).then(c => { const sc = document.createElement('canvas'); sc.width = c.width * 0.6; sc.height = c.height * 0.6; sc.getContext('2d').drawImage(c, 0, 0, sc.width, sc.height); sc.toBlob(b => navigator.clipboard.write([new ClipboardItem({ "image/png": b })]).then(() => alert("Copied!")), 'image/png', 0.9); document.body.style.zoom = oz; }); }
        function closeReports() { document.getElementById('reportsModal').style.display = 'none'; }
        function closeLoading() { document.getElementById('loadingOverlay').style.display = 'none'; document.getElementById('progressSection').classList.remove('hidden'); document.getElementById('successSection').classList.add('hidden'); }

        function openReports() { 
            document.getElementById('reportsModal').style.display = 'flex'; 
            showReport('Discounted');
        }

        function showReport(type) {
            const area = document.getElementById('reportsArea');
            const countLabel = document.getElementById('reportCount');
            const btns = document.querySelectorAll('#reportsModal button[id^="btnRep"]');
            btns.forEach(b => b.classList.remove('bg-indigo-600'));
            
            if(type === 'Discounted') document.getElementById('btnRepDisc').classList.add('bg-indigo-600');
            if(type === 'FreeDays') document.getElementById('btnRepFree').classList.add('bg-indigo-600');
            if(type === 'Expired') document.getElementById('btnRepExp').classList.add('bg-indigo-600');
            
            area.innerHTML = '';
            
            const latestVersions = {};
            globalRecords.forEach(r => {
                const vNum = parseInt((r.ver || "Version 1").replace(/\D/g, '')) || 1;
                if (!latestVersions[r.name] || vNum > latestVersions[r.name]) {
                    latestVersions[r.name] = vNum;
                }
            });

            let filtered = [];
            const today = new Date();
            today.setHours(0,0,0,0);

            if (type === 'Expired') {
                filtered = globalRecords.filter(r => {
                    let isExpiredDate = false;
                    if (r.dates && r.dates.includes('to')) {
                        const end = new Date(r.dates.split('to')[1]?.trim());
                        if(end < today) isExpiredDate = true;
                    }
                    const vNum = parseInt((r.ver || "Version 1").replace(/\D/g, '')) || 1;
                    const isSuperseded = vNum < latestVersions[r.name];
                    return isExpiredDate || isSuperseded;
                });
            } else {
                filtered = globalRecords.filter(r => {
                    if (r.mode !== type) return false;
                    const vNum = parseInt((r.ver || "Version 1").replace(/\D/g, '')) || 1;
                    const isOldVer = vNum < latestVersions[r.name];
                    return !isOldVer;
                });
            }

            currentReportData = filtered; 

            if (filtered.length === 0) {
                area.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No records found for this category.</div>';
            } else {
                filtered.sort((a,b) => a.name.localeCompare(b.name));
                filtered.forEach(r => {
                    const endDateStr = r.dates ? r.dates.split('to')[1]?.trim() : "N/A";
                    let status = "Active";
                    let statusClass = "text-green-600 bg-green-100";
                    
                    if (endDateStr !== "N/A") {
                        const end = new Date(endDateStr);
                        if (end < today) { status = "Expired"; statusClass = "text-red-600 bg-red-100"; }
                    }
                    
                    const vNum = parseInt((r.ver || "Version 1").replace(/\D/g, '')) || 1;
                    if (vNum < latestVersions[r.name]) {
                        status = "Old Ver";
                        statusClass = "text-gray-600 bg-gray-200";
                    }

                    let detailsHtml = "";
                    if (type === 'FreeDays') {
                        detailsHtml = `<span class="text-green-700 font-extrabold">${r.free || 'N/A'}</span>`;
                    } else {
                        let slabDetails = [];
                        try {
                            if (r.jF) {
                                const fInputs = JSON.parse(r.jF);
                                fInputs.forEach((row, idx) => {
                                    if(factoryData[idx]) {
                                        const dTotal = row.reduce((a,b)=>a+(parseFloat(b)||0),0);
                                        let sName = factoryData[idx].slab.replace('(20) ','').replace('For ','');
                                        if (dTotal > 0) slabDetails.push(`${sName}: â‚¹${dTotal}`);
                                    }
                                });
                            }
                            if (r.jI) {
                                const iInputs = JSON.parse(r.jI);
                                iInputs.forEach((row, idx) => {
                                    if(icdData[idx]) {
                                        const dTotal = row.reduce((a,b)=>a+(parseFloat(b)||0),0);
                                        let sName = icdData[idx].slab.replace('(20) ','').replace('For ','');
                                        if (dTotal > 0) slabDetails.push(`ICD ${sName}: â‚¹${dTotal}`);
                                    }
                                });
                            }
                        } catch(e) {}
                        if(slabDetails.length > 0) detailsHtml = `<span class="text-[10px] text-gray-600 font-bold">${slabDetails.join(' | ')}</span>`;
                        else detailsHtml = `<span class="text-gray-400">No Discount</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center px-4 py-2 border-b border-gray-200 hover:bg-gray-50 text-xs text-gray-800";
                    div.innerHTML = `
                        <div class="w-1/5 font-bold text-blue-900">${r.name} <span class="text-[10px] text-gray-400 font-normal">(${r.ver || 'V1'})</span></div>
                        <div class="w-1/12">${r.mode || '-'}</div>
                        <div class="w-1/2 overflow-hidden text-ellipsis whitespace-nowrap">${detailsHtml}</div>
                        <div class="w-1/12 text-center font-mono">${endDateStr}</div>
                        <div class="w-1/12 text-right"><span class="px-2 py-0.5 rounded ${statusClass} font-bold text-[10px] whitespace-nowrap">${status}</span></div>
                    `;
                    div.onclick = () => { closeReports(); loadRecord(r); };
                    div.style.cursor = 'pointer';
                    area.appendChild(div);
                });
            }
            countLabel.innerText = `${filtered.length} Records found`;
        }

        function downloadReportExcel() {
            if (!currentReportData || currentReportData.length === 0) return alert("No data to download!");
            
            const headers = [
                "Customer Name", "Version", "Mode", 
                "Discount Details (Summary)", 
                "End Date", "Status", 
                "Factory 0-27MT (â‚¹)", "Factory 27-30MT (â‚¹)", "Factory >31MT (â‚¹)", "Factory 40\" (â‚¹)", 
                "ICD 0-27MT (â‚¹)", "ICD 27-30MT (â‚¹)", "ICD >31MT (â‚¹)", "ICD 40\" (â‚¹)", 
                "Free Days"
            ];
            
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
            
            currentReportData.forEach(r => {
                const endDateStr = r.dates ? r.dates.split('to')[1]?.trim() : "N/A";
                
                let slabDetails = [];
                let fDisc = ["0","0","0","0"];
                let iDisc = ["0","0","0","0"];

                try {
                    if (r.jF) {
                        const fInputs = JSON.parse(r.jF);
                        fInputs.forEach((row, idx) => {
                            if(factoryData[idx]) {
                                const dTotal = row.reduce((a,b)=>a+(parseFloat(b)||0),0);
                                if(idx < 4) fDisc[idx] = dTotal > 0 ? dTotal : "0"; 
                                let sName = factoryData[idx].slab.replace('(20) ','').replace('For ','');
                                if (dTotal > 0) slabDetails.push(`${sName}: â‚¹${dTotal}`);
                            }
                        });
                    }
                    if (r.jI) {
                        const iInputs = JSON.parse(r.jI);
                        iInputs.forEach((row, idx) => {
                            if(icdData[idx]) {
                                const dTotal = row.reduce((a,b)=>a+(parseFloat(b)||0),0);
                                if(idx < 4) iDisc[idx] = dTotal > 0 ? dTotal : "0"; 

                                let sName = icdData[idx].slab.replace('(20) ','').replace('For ','');
                                if (dTotal > 0) slabDetails.push(`ICD ${sName}: â‚¹${dTotal}`);
                            }
                        });
                    }
                } catch(e) {}

                let summaryText = "";
                if(r.mode === 'FreeDays') {
                    summaryText = `Free Days: ${r.free || 'N/A'}`;
                } else {
                    summaryText = slabDetails.length > 0 ? slabDetails.join(' | ') : "No Discount";
                }
                
                const safeName = `"${(r.name || "").replace(/"/g, '""')}"`;
                const safeSummary = `"${summaryText.replace(/"/g, '""')}"`;
                
                const freeDaysVal = r.mode === 'FreeDays' ? (r.free || "0") : "0";
                
                const row = [
                    safeName, 
                    r.ver || 'V1', 
                    r.mode || '-', 
                    safeSummary, 
                    endDateStr, 
                    "Active",
                    fDisc[0], fDisc[1], fDisc[2], fDisc[3],
                    iDisc[0], iDisc[1], iDisc[2], iDisc[3],
                    freeDaysVal
                ];
                
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Tariff_Report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleApproval(input) {
            const file = input.files[0]; if (!file) return;
            const custName = document.getElementById('customerName').value || "Unknown";
            const version = document.getElementById('version').value || "V1";
            const ext = file.name.split('.').pop();
            const newFileName = `${custName.replace(/[^a-z0-9]/gi, '_')}_${version}.${ext}`;
            const link = document.createElement('a'); link.href = URL.createObjectURL(file); link.download = newFileName; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            const previewSection = document.getElementById('approvalPreviewSection');
            const container = document.getElementById('previewContainer');
            document.getElementById('approvalFileName').innerText = `Attached: ${newFileName}`;
            previewSection.classList.remove('hidden'); container.innerHTML = '';
            if (['jpg', 'jpeg', 'png'].includes(ext.toLowerCase())) {
                const img = document.createElement('img'); img.src = URL.createObjectURL(file); img.className = "max-h-full max-w-full object-contain"; container.appendChild(img);
            } else { container.innerHTML = `<p class="text-red-500 font-bold">Saved to PC (No Preview)</p>`; }
        }

        // --- CUSTOMER SUGGESTION LOGIC ---
        function suggestCustomer(val) {
            const box = document.getElementById('suggestionBox');
            if (!val || val.length < 2) { 
                box.classList.add('hidden'); 
                return; 
            }

            const uniqueNames = [...new Set(globalRecords.map(r => r.name))];
            const matches = uniqueNames.filter(n => n.toLowerCase().includes(val.toLowerCase()));

            if (matches.length === 0) { 
                box.classList.add('hidden'); 
                return; 
            }

            let html = '';
            matches.forEach(name => {
                html += `<div onclick="selectSuggestion('${name}')" class="p-2 hover:bg-blue-100 cursor-pointer text-xs font-bold text-blue-900 border-b border-gray-100 uppercase">${name}</div>`;
            });

            box.innerHTML = html;
            box.classList.remove('hidden');
        }

        function selectSuggestion(name) {
            document.getElementById('customerName').value = name;
            document.getElementById('suggestionBox').classList.add('hidden');
        }

        // --- FILTER BOX SUGGESTION LOGIC ---
        function suggestFilter(val) {
            const box = document.getElementById('filterSuggestionBox');
            if (!val) { 
                box.classList.add('hidden'); 
                return; 
            }

            const uniqueNames = [...new Set(globalRecords.map(r => r.name))];
            const matches = uniqueNames.filter(n => n.toLowerCase().includes(val.toLowerCase()));

            if (matches.length === 0) { 
                box.classList.add('hidden'); 
                return; 
            }

            let html = '';
            matches.forEach(name => {
                html += `<div onclick="selectFilterSuggestion('${name}')" class="p-2 hover:bg-blue-100 cursor-pointer text-xs font-bold text-gray-800 border-b border-gray-100 uppercase">${name}</div>`;
            });

            box.innerHTML = html;
            box.classList.remove('hidden');
        }

        function selectFilterSuggestion(name) {
            const input = document.getElementById('filterInput');
            input.value = name;
            document.getElementById('filterSuggestionBox').classList.add('hidden');
            filterDropdown(name);
        }

        // GLOBAL CLICK LISTENER
        document.addEventListener('click', function(e) {
            if (e.target.id !== 'customerName') {
                const box = document.getElementById('suggestionBox');
                if(box) box.classList.add('hidden');
            }
            if (e.target.id !== 'filterInput') {
                const box = document.getElementById('filterSuggestionBox');
                if(box) box.classList.add('hidden');
            }
        });

        // --- DYNAMIC TABLE LOGIC ---
        function askAddTable() {
            let type = prompt("Enter Table Type:\n1 for Factory Destuffing\n2 for ICD Destuffing");
            if (type === '1') {
                createDynamicTable('Factory');
            } else if (type === '2') {
                createDynamicTable('ICD');
            } else if (type) {
                alert("Invalid Selection! Enter 1 or 2.");
            }
        }

        function createDynamicTable(type, savedData = null) {
            const container = document.getElementById('dynamicTablesArea');
            const uniqueID = Date.now() + Math.floor(Math.random() * 1000); 
            const wrapper = document.createElement('div');
            wrapper.className = "mb-8 animate-fade-in dynamic-table-wrapper"; 
            wrapper.id = `wrapper_${uniqueID}`;
            wrapper.dataset.type = type; 

            const isFactory = type === 'Factory';
            const colorClass = isFactory ? 'blue' : 'purple';
            const colCount = isFactory ? 6 : 7;
            const dataSet = isFactory ? factoryData : icdData;
            const title = isFactory ? 'Factory Destuffing Tariff' : 'ICD Destuffing Weight Slab';
            const icon = isFactory ? 'fa-industry' : 'fa-warehouse';

            const valStart = savedData ? savedData.start : '';
            const valEnd = savedData ? savedData.end : '';

            let html = `
                <div class="bg-gray-200 p-2 rounded-t flex justify-between items-center border border-gray-400 border-b-0">
                    <div class="flex gap-4 items-center">
                        <span class="text-${colorClass}-900 font-extrabold text-sm uppercase"><i class="fas ${icon} mr-2"></i>${title}</span>
                    </div>
                    <div class="flex gap-2 items-center">
                        <div class="flex items-center bg-white px-2 py-0.5 rounded border border-gray-300">
                            <span class="text-[10px] font-bold text-gray-500 mr-2 uppercase">Start:</span>
                            <input type="date" value="${valStart}" class="dyn-start-date text-xs font-bold text-blue-900 border-none outline-none bg-transparent h-6">
                        </div>
                        <div class="flex items-center bg-white px-2 py-0.5 rounded border border-gray-300">
                            <span class="text-[10px] font-bold text-gray-500 mr-2 uppercase">End:</span>
                            <input type="date" value="${valEnd}" class="dyn-end-date text-xs font-bold text-blue-900 border-none outline-none bg-transparent h-6">
                        </div>
                        <button onclick="document.getElementById('wrapper_${uniqueID}').remove()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-[10px] font-bold uppercase shadow ml-2">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            `;

            html += `<table class="tariff-table border-2 border-${colorClass}-900"><thead><tr>
                    <th class="bg-gray-700 text-white w-[10%]" rowspan="2">Weight Slab</th>
                    <th class="bg-header-public" colspan="${isFactory ? 7 : 8}">PUBLIC TARIFF (INR)</th>
                    <th class="bg-header-discount" colspan="${isFactory ? 7 : 8}">DISCOUNTED TARIFF (INR)</th>
                    <th class="bg-black text-white w-[8%]" rowspan="2">Total Billing<br><span class="text-[9px] font-normal">(Public - Disc)</span></th>
                    </tr><tr class="text-[9px]">
                    ${isFactory ? '' : `<th class="bg-${colorClass}-800 text-white">Destuff</th>`}
                    <th class="bg-${colorClass}-800 text-white">THC</th> <th class="bg-${colorClass}-800 text-white">Infra.</th> <th class="bg-${colorClass}-800 text-white">Weighment</th> <th class="bg-${colorClass}-800 text-white">Energy</th> <th class="bg-${colorClass}-800 text-white">EIC/Cong</th> <th class="bg-${colorClass}-800 text-white">Port SSR</th> <th class="bg-${colorClass}-900 border-l border-white text-white">Total</th>
                    ${isFactory ? '' : `<th class="bg-green-700 text-white">Destuff</th>`}
                    <th class="bg-green-700 text-white">THC</th> <th class="bg-green-700 text-white">Infra.</th> <th class="bg-green-700 text-white">Weighment</th> <th class="bg-green-700 text-white">Energy</th> <th class="bg-green-700 text-white">EIC/Cong</th> <th class="bg-green-700 text-white">Port SSR</th> <th class="bg-green-900 border-l border-white text-white">Total Disc</th>
                    </tr></thead><tbody>`;

            dataSet.forEach((row, rIdx) => {
                const uid = `dyn_${uniqueID}_${rIdx}`;
                let pTotal = 0;
                
                const savedRowVals = savedData ? savedData.values[rIdx] : null;

                html += `<tr><td class="font-bold text-left px-2 bg-gray-50">${row.slab}</td>`;
                row.p.forEach((val, cIdx) => {
                    pTotal += val;
                    html += `<td><input type="number" id="${uid}_p${cIdx}" value="${val}" readonly tabindex="-1" class="text-blue-900 font-bold bg-gray-100 pointer-events-none"></td>`;
                });
                html += `<td class="bg-blue-100 font-extrabold text-blue-900" id="${uid}_ptotal">${pTotal}</td>`;

                for(let i=0; i<colCount; i++) {
                    const v = savedRowVals ? savedRowVals[i] : '';
                    html += `<td><input type="number" id="${uid}_d${i}" value="${v}" oninput="calcRow('${uid}', ${colCount})" class="dyn-input text-green-700 font-bold border-b border-green-100"></td>`;
                }

                html += `<td class="bg-green-100 text-red-600 font-extrabold" id="${uid}_dtotal">0</td><td class="bg-black text-white font-bold" id="${uid}_final">${pTotal}</td></tr>`;
            });

            html += `</tbody></table>`;
            wrapper.innerHTML = html;
            container.appendChild(wrapper);

            dataSet.forEach((_, rIdx) => calcRow(`dyn_${uniqueID}_${rIdx}`, colCount));
        }
    </script>
</body>
</html>
